<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #2b2b2b;
            color: #e6e6e6;
        }
        .sidebar, .options-panel {
            background-color: #1e1e1e;
        }
        .image-area {
            background-color: #333333;
        }
        .btn-tool {
            text-align: left;
            width: 100%;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <!-- Sidebar -->
            <div class="col-2 p-3 sidebar">
                <h5 class="mb-3 border-bottom pb-2">Tools</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-secondary btn-tool" onclick="showOptions('resize')">Resize</button>
                    <button class="btn btn-secondary btn-tool" onclick="showOptions('rotate')">Rotate</button>
                    <button class="btn btn-secondary btn-tool" onclick="showOptions('blur')">Blur</button>
                    <button class="btn btn-secondary btn-tool" onclick="showOptions('adjust')">Brightness & Contrast</button>
                    <button class="btn btn-secondary btn-tool" onclick="showOptions('adjust_color')">Color Adjustment</button>
                    <!-- Add more tool buttons here -->
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-8 d-flex flex-column">
                <!-- Toolbar -->
                <div class="p-2 bg-dark">
                    <form id="uploadForm" method="post" enctype="multipart/form-data" style="display: none;">
                        <input type="file" id="imageUpload" name="file" accept="image/*">
                    </form>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="document.getElementById('imageUpload').click()">Upload</button>
                    <button id="undoBtn" class="btn btn-sm btn-outline-light me-2" onclick="undo()" disabled>Undo</button>
                    <button id="redoBtn" class="btn btn-sm btn-outline-light me-2" onclick="redo()" disabled>Redo</button>
                    <button class="btn btn-sm btn-outline-light" onclick="saveImage()">Save</button>
                </div>
                <!-- Image Area -->
                <div class="flex-grow-1 image-area d-flex justify-content-center align-items-center position-relative">
                    <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="Uploaded image" id="mainImage" class="img-fluid">
                    <div class="position-absolute bottom-0 end-0 m-3">
                        <button class="btn btn-sm btn-dark" onclick="zoomIn()">+</button>
                        <button class="btn btn-sm btn-dark" onclick="zoomOut()">-</button>
                    </div>
                </div>
            </div>

            <!-- Options Panel -->
            <div class="col-2 p-3 options-panel">
                <h5 class="mb-3 border-bottom pb-2">Options</h5>
                <div id="formContainer">
                    <!-- Forms will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    
    <script>
        let undoStack = [];
        let redoStack = [];
        const maxStackSize = 20;
        function updateUndoRedoButtons() {
    document.getElementById('undoBtn').disabled = undoStack.length <= 1;
    document.getElementById('redoBtn').disabled = redoStack.length === 0;
}
        function saveState() {
            const img = document.getElementById('mainImage');
            undoStack.push(img.src);
            if (undoStack.length > maxStackSize) {
                undoStack.shift(); // Remove the oldest state if we exceed the max size
            }
            redoStack = []; // Clear the redo stack when a new action is performed
            updateUndoRedoButtons();
        }
        // Your JavaScript functions here
        function showOptions(action) {
            const forms = document.querySelectorAll('#formContainer form');
            forms.forEach(form => form.classList.add('hidden'));
            const selectedForm = document.getElementById(`${action}Form`);
            if (selectedForm) {
                selectedForm.classList.remove('hidden');
            } else {
                console.error(`Form for action "${action}" not found`);
            }
        }

        function zoomIn() {
            const img = document.getElementById('mainImage');
            img.style.width = (img.width * 1.1) + 'px';
        }

        function zoomOut() {
            const img = document.getElementById('mainImage');
            img.style.width = (img.width * 0.9) + 'px';
        }

        function undo() {
            if (undoStack.length > 1) { // Keep at least one state in the undo stack
                const currentState = undoStack.pop();
                redoStack.push(currentState);
                const previousState = undoStack[undoStack.length - 1];
                document.getElementById('mainImage').src = previousState;
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                document.getElementById('mainImage').src = nextState;
            }
        }

        // Image upload handling
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
        const formData = new FormData(document.getElementById('uploadForm'));
        fetch('/', { // Adjust this URL to match your backend upload endpoint
            method: 'POST',
            body: formData
        })
        .then(response => response.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            //document.getElementById('mainImage').src = url;
            undoStack = [url]; // Initialize undo stack with the original image
            redoStack = []; // Clear redo stack
            updateUndoRedoButtons();
        })
        .catch(error => console.error('Error:', error));
    }
        });

        const formConfigs = {
            resize: {
                title: "Resize",
                inputs: [
                    {type: "number", name: "scale", label: "Resize (%)", min: 1, max: 200, value: 100}
                ]
            },
            rotate: {
                title: "Rotate",
                inputs: [
                    {type: "number", name: "angle", label: "Rotate (degrees)", min: 0, max: 360, value: 0}
                ]
            },
            blur: {
                title: "Blur",
                inputs: [
                    {type: "range", name: "blur_radius", label: "Blur Radius", min: 0, max: 10, step: 0.1, value: 1}
                ]
            },
            adjust: {
                title: "Brightness & Contrast",
                inputs: [
                    {type: "range", name: "brightness", label: "Brightness", min: 0, max: 2, step: 0.1, value: 1},
                    {type: "range", name: "contrast", label: "Contrast", min: 0, max: 2, step: 0.1, value: 1}
                ]
            },
            adjust_color: {
                title: "Color Adjustment",
                inputs: [
                    {type: "range", name: "hue", label: "Hue", min: 0, max: 360, value: 0},
                    {type: "range", name: "saturation", label: "Saturation", min: 0, max: 2, step: 0.1, value: 1},
                    {type: "range", name: "red", label: "Red", min: 0, max: 2, step: 0.1, value: 1},
                    {type: "range", name: "green", label: "Green", min: 0, max: 2, step: 0.1, value: 1},
                    {type: "range", name: "blue", label: "Blue", min: 0, max: 2, step: 0.1, value: 1}
                ]
            },
            // Add more form configurations as needed
        };

        function generateForm(action, config, isFirst) {
            const form = document.createElement('form');
            form.id = `${action}Form`;
            form.method='POST'
            if (!isFirst) {
                form.classList.add('hidden');
            }

            const title = document.createElement('h5');
            title.textContent = config.title;
            form.appendChild(title);

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'action';
            hiddenInput.value = action;
            form.appendChild(hiddenInput);

            config.inputs.forEach(input => {
                const div = document.createElement('div');
                div.classList.add('mb-3');

                const label = document.createElement('label');
                label.textContent = input.label;
                label.classList.add('form-label');
                label.htmlFor = input.name;
                div.appendChild(label);

                const inputElement = document.createElement('input');
                inputElement.type = input.type;
                inputElement.name = input.name;
                inputElement.id = input.name;
                inputElement.classList.add('form-control');
                for (const attr in input) {
                    if (['min', 'max', 'step', 'value'].includes(attr)) {
                        inputElement[attr] = input[attr];
                    }
                }
                div.appendChild(inputElement);

                form.appendChild(div);
            });

            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.classList.add('btn', 'btn-primary');
            submitButton.textContent = `Apply ${config.title}`;
            form.appendChild(submitButton);

            form.onsubmit = function(e) {
                e.preventDefault(); // We'll still prevent default, but handle the submission ourselves
                saveState(); // Save the current state before applying the action
                
                const formData = new FormData(form);
                fetch(window.location.pathname, { // Adjust this URL to match your backend endpoint
                    method: 'POST',
                    body: formData
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    //document.getElementById('mainImage').src = url;
                    saveState(); // Save the new state after applying the action
                })
                .catch(error => console.error('Error:', error));
            };

            return form;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const formContainer = document.getElementById('formContainer');
            const actions = Object.keys(formConfigs);
            actions.forEach((action, index) => {
                const form = generateForm(action, formConfigs[action], index === 0);
                formContainer.appendChild(form);
            });
        });
        function saveImage() {
    // Show the save options modal
    const saveModal = new bootstrap.Modal(document.getElementById('saveModal'));
    saveModal.show();
}

function downloadImage() {
    const img = document.getElementById('mainImage');
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    canvas.getContext('2d').drawImage(img, 0, 0);
    
    const fileName = document.getElementById('fileName').value || 'processed_image';
    const fileType = document.getElementById('fileType').value;
    
    canvas.toBlob(function(blob) {
        const link = document.createElement('a');
        link.download = `${fileName}.${fileType}`;
        link.href = URL.createObjectURL(blob);
        link.click();
        URL.revokeObjectURL(link.href);
        
        // Close the modal
        const saveModal = bootstrap.Modal.getInstance(document.getElementById('saveModal'));
        saveModal.hide();
    }, `image/${fileType}`);
}
    </script>
    <div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="saveModalLabel">Save Image</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="saveForm">
                <div class="mb-3">
                  <label for="fileName" class="form-label">File Name</label>
                  <input type="text" class="form-control" id="fileName" value="processed_image">
                </div>
                <div class="mb-3">
                  <label for="fileType" class="form-label">File Type</label>
                  <select class="form-select" id="fileType">
                    <option value="png">PNG</option>
                    <option value="jpeg">JPEG</option>
                    <option value="webp">WebP</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="downloadImage()">Save</button>
            </div>
          </div>
        </div>
      </div>
</body>
</html>